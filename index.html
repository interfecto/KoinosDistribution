<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Koinos Live Token Distribution</title>
  <!-- Load Plotly from CDN -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      background-color: #1e1e1e;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    #chart {
      width: 100%;
      max-width: 800px;
      height: 80vh;
      margin: auto;
    }
    h1 {
      margin-bottom: 20px;
    }
    footer {
      margin-top: 20px;
      font-size: 14px;
    }
    footer a {
      color: #00aced;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <h1>Koinos Token Holder Distribution (Live)</h1>
  <div id="chart"></div>
  
  <!-- Footer with credits -->
  <footer>
    <p>
      Visit <a href="https://koinos.io/" target="_blank">Koinos.io</a> &nbsp;|&nbsp; Powered by the
      <a href="https://koiner.app/" target="_blank">Koiner.app API</a>
    </p>
  </footer>
  
  <script>
    // Mapping of special wallet addresses to custom labels.
    const specialLabels = {
      "1Kq55nFXNjP8DefaG9vJYqVpNja5ij3j5C": "Chainge Finance",
      "162GhJwsciDiKsgwzj2t6VoFHt3RMzGKdG": "Koinos Box Mana sharer"
    };

    async function fetchKoinosData() {
      const endpoint = "https://api.koiner.app/graphql";
      const query = `
        query GetKoinHoldersPage1 {
          tokenHolders(
            first: 500,
            filter: { contractId: { equals: "19GYjDBVXU7keLbYvMLazsGQn3GTWHjHkK" } }
            sort: [{ direction: desc, field: balance }]
          ) {
            edges {
              node {
                id
                addressId
                balance
              }
            }
            pageInfo {
              hasNextPage
              endCursor
            }
          }
        }
      `;
      
      const response = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query, operationName: "GetKoinHoldersPage1" })
      });
      
      const result = await response.json();
      return result.data.tokenHolders.edges.map(edge => ({
        wallet: edge.node.addressId || edge.node.id,
        balance: parseInt(edge.node.balance, 10) / 1e8
      }));
    }
    
    async function updateChart() {
      try {
        const holders = await fetchKoinosData();
        // Sort holders in descending order by balance.
        holders.sort((a, b) => b.balance - a.balance);
        const topHolders = holders.slice(0, 500);
        const topSum = topHolders.reduce((acc, cur) => acc + cur.balance, 0);
        
        // Hardcoded circulating supply.
        const circulatingSupply = 82452065;
        // Calculate "Others/Burned" as circulating supply minus the sum of the top 500.
        const othersTotal = circulatingSupply > topSum ? circulatingSupply - topSum : 0;
        
        // Build labels:
        // Use a custom label if defined; else for the largest, label "MEXC", else blank.
        const labels = topHolders.map((d, index) => {
          if(specialLabels[d.wallet]) {
            return specialLabels[d.wallet];
          } else if(index === 0) {
            return "MEXC";
          } else {
            return "";
          }
        });
        // Set aggregated slice label to "Others/Burned"
        labels.push("Others/Burned");
        
        // Build values: balances for the top holders plus the computed others value.
        const values = topHolders.map(d => d.balance);
        values.push(othersTotal);
        
        // Custom data for click events.
        const customData = topHolders.map(holder => holder.wallet);
        customData.push("");
        
        const plotData = [{
          type: 'pie',
          labels: labels,
          values: values,
          customdata: customData,
          textinfo: 'none',   // No in-slice text; use hover info.
          hoverinfo: 'label+value+percent',
          hole: 0.4,
          marker: {
            colors: Plotly.d3.schemeCategory10
          }
        }];
        
        const layout = {
          title: 'KOINOS Token Holder Distribution (Top 500)',
          paper_bgcolor: "#1e1e1e",
          plot_bgcolor: "#1e1e1e",
          font: { color: "white", size: 14 },
          showlegend: false,
          annotations: [
            {
              x: 0.5,
              y: -0.1,
              xref: "paper",
              yref: "paper",
              text: "Claimed Koin: 75,77% | Total accounts: 19.026",
              showarrow: false,
              font: { size: 14, color: "white" }
            }
          ]
        };
        
        Plotly.newPlot('chart', plotData, layout);
        
        // Click event: open wallet page on Koiner.app.
        const chartDiv = document.getElementById('chart');
        chartDiv.on('plotly_click', function(data) {
          var pt = data.points[0];
          var wallet = pt.customdata;
          if(wallet) {
            var url = "https://koiner.app/addresses/" + wallet;
            window.open(url, "_blank");
          }
        });
        
      } catch (error) {
        console.error("Error fetching or plotting data:", error);
      }
    }
    
    // Initial load and refresh every 5 minutes (300,000 ms)
    updateChart();
    setInterval(updateChart, 300000);
  </script>
</body>
</html>
